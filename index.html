<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clinical Communication Aid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
          --bg-color-light: #f1f5f9; /* slate-100 */
          --bg-gradient-light-1: hsla(212,96%,48%,0.1);
          --bg-gradient-light-2: hsla(266,85%,55%,0.05);
          --bg-gradient-light-3: hsla(320,80%,50%,0.05);
          --bg-gradient-light-4: hsla(180,96%,30%,0.1);

          --bg-color-dark: #020617; /* slate-950 */
          --bg-gradient-dark-1: hsla(212,96%,48%,0.2);
          --bg-gradient-dark-2: hsla(266,85%,55%,0.15);
          --bg-gradient-dark-3: hsla(320,80%,50%,0.15);
          --bg-gradient-dark-4: hsla(180,96%,30%,0.2);
      }
      
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: var(--bg-color-light);
        background-image:
            radial-gradient(at 20% 20%, var(--bg-gradient-light-1) 0px, transparent 50%),
            radial-gradient(at 80% 20%, var(--bg-gradient-light-2) 0px, transparent 50%),
            radial-gradient(at 20% 80%, var(--bg-gradient-light-3) 0px, transparent 50%),
            radial-gradient(at 80% 80%, var(--bg-gradient-light-4) 0px, transparent 50%);
        background-attachment: fixed;
      }

      .dark body {
          background-color: var(--bg-color-dark);
          background-image:
              radial-gradient(at 20% 20%, var(--bg-gradient-dark-1) 0px, transparent 50%),
              radial-gradient(at 80% 20%, var(--bg-gradient-dark-2) 0px, transparent 50%),
              radial-gradient(at 20% 80%, var(--bg-gradient-dark-3) 0px, transparent 50%),
              radial-gradient(at 80% 80%, var(--bg-gradient-dark-4) 0px, transparent 50%);
      }

      @keyframes pulse-ring {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1.2); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
      }
      .listening-pulse {
        animation: pulse-ring 1.5s infinite;
      }
      
      /* Basic support for react-animate-in */
      @keyframes keyframes-fade-in { from { opacity: 0; } to { opacity: 1; } }
      @keyframes keyframes-zoom-in-95 { from { opacity: 0; transform: scale(.95); } to { opacity: 1; transform: scale(1); } }
      @keyframes keyframes-slide-in-from-top-4 { from { transform: translateY(-1rem); } to { transform: translateY(0); } }
      .animate-in { animation: keyframes-fade-in 0.3s ease-out; }
      .fade-in-0 { animation-name: keyframes-fade-in; }
      .zoom-in-95 { animation-name: keyframes-zoom-in-95; }
      .slide-in-from-top-4 { animation-name: keyframes-slide-in-from-top-4; }

    </style>
    <!-- Babel for JSX and modern JS transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for loading ES modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/genai": "https://esm.sh/@google/genai@^1.12.0",
        "jspdf": "https://esm.sh/jspdf@2.5.1"
      }
    }
    </script>
    <script>
        // Avoids flashing the wrong theme on page load
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
// --- EXTERNAL IMPORTS ---
import React, { useState, useCallback, useRef, useEffect } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from "@google/genai";
import { jsPDF } from "jspdf";

// --- CONSTANTS ---
const SUPPORTED_LANGUAGES = [
    { name: 'Common Languages', isHeader: true },
    { name: 'English (US)', code: 'en-US' },
    { name: 'Spanish (Mexico)', code: 'es-MX' },
    { name: 'Chinese (Mandarin, Simplified)', code: 'zh-CN' },
    { name: 'Dutch', code: 'nl-NL' },

    { name: 'Middle East & North Africa', isHeader: true },
    { name: 'Arabic (Standard)', code: 'ar-SA' },
    { name: 'Arabic (Egypt)', code: 'ar-EG' },
    { name: 'Arabic (Syria)', code: 'ar-SY' },
    { name: 'Arabic (Iraq)', code: 'ar-IQ' },
    { name: 'Arabic (Morocco)', code: 'ar-MA' },
    { name: 'Farsi (Persian)', code: 'fa-IR' },
    { name: 'Hebrew', code: 'he-IL' },
    { name: 'Kurdish (Sorani)', code: 'ckb-IQ' },
    { name: 'Turkish', code: 'tr-TR' },

    { name: 'South Asia', isHeader: true },
    { name: 'Bengali', code: 'bn-IN' },
    { name: 'Gujarati', code: 'gu-IN' },
    { name: 'Hindi', code: 'hi-IN' },
    { name: 'Kannada', code: 'kn-IN' },
    { name: 'Malayalam', code: 'ml-IN' },
    { name: 'Marathi', code: 'mr-IN' },
    { name: 'Nepali', code: 'ne-NP' },
    { name: 'Pashto', code: 'ps-AF' },
    { name: 'Punjabi (Gurmukhi)', code: 'pa-IN' },
    { name: 'Sindhi', code: 'sd-IN' },
    { name: 'Sinhala', code: 'si-LK' },
    { name: 'Tamil', code: 'ta-IN' },
    { name: 'Telugu', code: 'te-IN' },
    { name: 'Urdu', code: 'ur-PK' },

    { name: 'East & Southeast Asia', isHeader: true },
    { name: 'Burmese', code: 'my-MM' },
    { name: 'Chinese (Cantonese, Traditional)', code: 'zh-HK' },
    { name: 'Filipino', code: 'fil-PH' },
    { name: 'Indonesian', code: 'id-ID' },
    { name: 'Japanese', code: 'ja-JP' },
    { name: 'Javanese', code: 'jv-ID' },
    { name: 'Khmer', code: 'km-KH' },
    { name: 'Korean', code: 'ko-KR' },
    { name: 'Lao', code: 'lo-LA' },
    { name: 'Malaysian', code: 'ms-MY' },
    { name: 'Sundanese', code: 'su-ID' },
    { name: 'Thai', code: 'th-TH' },
    { name: 'Vietnamese', code: 'vi-VN' },

    { name: 'Europe', isHeader: true },
    { name: 'Catalan', code: 'ca-ES' },
    { name: 'Czech', code: 'cs-CZ' },
    { name: 'Danish', code: 'da-DK' },
    { name: 'Finnish', code: 'fi-FI' },
    { name: 'French (France)', code: 'fr-FR' },
    { name: 'German', code: 'de-DE' },
    { name: 'Greek', code: 'el-GR' },
    { name: 'Hungarian', code: 'hu-HU' },
    { name: 'Italian', code: 'it-IT' },
    { name: 'Norwegian', code: 'no-NO' },
    { name: 'Polish', code: 'pl-PL' },
    { name: 'Portuguese (Portugal)', code: 'pt-PT' },
    { name: 'Romanian', code: 'ro-RO' },
    { name: 'Russian', code: 'ru-RU' },
    { name: 'Slovak', code: 'sk-SK' },
    { name: 'Spanish (Spain)', code: 'es-ES' },
    { name: 'Swedish', code: 'sv-SE' },
    { name: 'Ukrainian', code: 'uk-UA' },

    { name: 'Africa', isHeader: true },
    { name: 'Afrikaans', code: 'af-ZA' },
    { name: 'Amharic', code: 'am-ET' },
    { name: 'Hausa', code: 'ha-NG' },
    { name: 'Igbo', code: 'ig-NG' },
    { name: 'Somali', code: 'so-SO' },
    { name: 'Swahili', code: 'sw-KE' },
    { name: 'Yoruba', code: 'yo-NG' },
    { name: 'Zulu', code: 'zu-ZA' },

    { name: 'Americas', isHeader: true },
    { name: 'English (UK)', code: 'en-GB' },
    { name: 'English (Canada)', code: 'en-CA' },
    { name: 'French (Canada)', code: 'fr-CA' },
    { name: 'Portuguese (Brazil)', code: 'pt-BR' },
    { name: 'Spanish (Argentina)', code: 'es-AR' },
    { name: 'Spanish (US)', code: 'es-US' },
];

const LANG_NAME_TO_BCP47 = SUPPORTED_LANGUAGES.reduce((acc, lang) => {
  if (lang.code) acc[lang.name] = lang.code;
  return acc;
}, {});

const STATUS_TRANSLATIONS = {
  'English': { tapToSpeak: 'Tap the microphone to speak', listening: 'Listening... Tap again to translate.', translating: 'Translating...', waiting: 'Waiting for the other person...' },
  'Dutch': { tapToSpeak: 'Tik op de microfoon om te spreken', listening: 'Luisteren... Tik opnieuw om te vertalen.', translating: 'Vertalen...', waiting: 'Wachten op de andere persoon...' },
  'Spanish': { tapToSpeak: 'Toca el micrófono para hablar', listening: 'Escuchando... Toca de nuevo para traducir.', translating: 'Traduciendo...', waiting: 'Esperando a la otra persona...' },
  'French': { tapToSpeak: 'Appuyez sur le micro pour parler', listening: 'Écoute... Appuyez à nouveau pour traduire.', translating: 'Traduction...', waiting: "En attente de l'autre personne..." },
};

// --- ICONS ---
const MicIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3z"></path><path d="M17 11a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h-2v2h6v-2h-2v-3.08A7 7 0 0 0 19 11h-2z"></path></svg>);
const DownloadIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15a1 1 0 0 1-.71-.29l-4-4a1 1 0 1 1 1.42-1.42L12 12.59l3.29-3.3a1 1 0 1 1 1.42 1.42l-4 4A1 1 0 0 1 12 15Z" /><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8Z" /><path d="M12 19a1 1 0 0 1-1-1v-4a1 1 0 0 1 2 0v4a1 1 0 0 1-1 1Z" /></svg>);
const SettingsIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.79 12.22a1 1 0 0 0-1.23.7l-.28 1.13a6.83 6.83 0 0 1-2.05 2.05l-1.13.28a1 1 0 0 0-.7 1.23 8 8 0 1 0-3.19-11.62 1 1 0 0 0 .7-1.23l.28-1.13a6.83 6.83 0 0 1 2.05-2.05l1.13-.28a1 1 0 0 0 1.23-.7A8 8 0 0 0 19.79 12.22ZM12 15a3 3 0 1 1 3-3 3 3 0 0 1-3 3Z"/></svg>);
const SwapIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.41 15.59 15 13.17V19a1 1 0 0 1-2 0v-5.83l-2.41 2.42a1 1 0 0 1-1.42 0 1 1 0 0 1 0-1.42l4.59-4.58a1 1 0 0 1 1.41 0l4.59 4.58a1 1 0 0 1 0 1.42 1 1 0 0 1-1.41 0ZM6.59 8.41 9 10.83V5a1 1 0 0 1 2 0v5.83l2.41-2.42a1 1 0 0 1 1.42 0 1 1 0 0 1 0 1.42l-4.59 4.58a1 1 0 0 1-1.41 0L5.17 9.83a1 1 0 0 1 1.42-1.42Z"/></svg>);
const SunIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>);
const MoonIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>);
const KeyIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.75 20H14v-2h2.75a.25.25 0 0 0 .25-.25V15a4 4 0 0 0-3.11-3.9A5.49 5.49 0 0 0 10.5 2a5.5 5.5 0 0 0-5 3.5 4 4 0 0 0-3.11 3.9v2.75a.25.25 0 0 0 .25.25H5v2H2.25a2.25 2.25 0 0 1-2.24-2L0 12.25a6 6 0 0 1 5.25-5.95A7.5 7.5 0 0 1 18 6.5a6 6 0 0 1 5.25 5.95l-.01.25a2.25 2.25 0 0 1-2.24 2Z" /><path d="M18 14a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1h-1v2h1a3 3 0 0 0 3-3v-1a3 3 0 0 0-3-3h-2v2h2Z" /></svg>);
const AppLogo = ({ className }) => (<svg className={className} viewBox="0 0 104 104" xmlns="http://www.w3.org/2000/svg"><g fillOpacity="0.7"><rect x="0" y="0" width="48" height="26" rx="13" fill="#00a0e0" /><rect x="0" y="0" width="26" height="48" rx="13" fill="#005aaa" /><rect x="56" y="0" width="48" height="26" rx="13" fill="#00a0e0" /><rect x="78" y="0" width="26" height="48" rx="13" fill="#005aaa" /><rect x="0" y="78" width="48" height="26" rx="13" fill="#005aaa" /><rect x="0" y="56" width="26" height="48" rx="13" fill="#00a0e0" /><rect x="56" y="78" width="48" height="26" rx="13" fill="#d480b0" /><rect x="78" y="56" width="26" height="48" rx="13" fill="#b4007a" /></g></svg>);


// --- HOOKS ---
const useTheme = () => {
  const [theme, setTheme] = useState(() => {
    if (typeof window !== 'undefined' && window.localStorage) {
      const storedTheme = window.localStorage.getItem('theme');
      if (storedTheme === 'light' || storedTheme === 'dark') return storedTheme;
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) return 'dark';
    }
    return 'light';
  });

  useEffect(() => {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('theme', 'light');
    }
  }, [theme]);

  const toggleTheme = () => setTheme(prev => (prev === 'light' ? 'dark' : 'light'));
  return [theme, toggleTheme];
};


// --- COMPONENTS ---
const ApiKeyGate = ({ onKeySubmit }) => {
    const [inputKey, setInputKey] = useState('');
    const handleSubmit = (e) => {
        e.preventDefault();
        if (inputKey.trim()) onKeySubmit(inputKey.trim());
    };
    return (
        <div className="fixed inset-0 bg-slate-900/30 dark:bg-black/50 backdrop-blur-lg z-50 flex items-center justify-center p-4">
            <div className="bg-slate-200/50 dark:bg-slate-900/40 backdrop-blur-2xl rounded-2xl shadow-xl w-full max-w-md p-6 sm:p-8 border border-slate-300 dark:border-white/20 animate-in fade-in-0 zoom-in-95">
                <div className="flex flex-col items-center text-center">
                    <div className="p-3 mb-4 rounded-full bg-sky-500/20 text-sky-600 dark:text-sky-300"><KeyIcon className="w-8 h-8"/></div>
                    <h1 className="text-2xl font-bold text-slate-900 dark:text-white mb-2">Enter your Gemini API Key</h1>
                    <p className="text-slate-600 dark:text-slate-300 mb-6">To use this application, please provide your API key. Your key is saved securely in your browser and never leaves your device.</p>
                </div>
                <form onSubmit={handleSubmit}>
                    <input type="password" value={inputKey} onChange={(e) => setInputKey(e.target.value)} placeholder="Paste your API key here..." className="w-full px-4 py-2.5 rounded-lg bg-slate-200/50 dark:bg-black/20 backdrop-blur-md border border-slate-300 dark:border-white/20 text-slate-900 dark:text-white focus:ring-2 focus:ring-sky-500 dark:focus:ring-sky-400 focus:border-sky-500 dark:focus:border-sky-400 transition" />
                    <button type="submit" className="w-full mt-4 px-4 py-2.5 rounded-lg text-white bg-sky-600 hover:bg-sky-500 disabled:bg-sky-600/50 transition-colors font-semibold" disabled={!inputKey.trim()}>Save and Continue</button>
                </form>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-4 text-center">Don't have a key? Get one from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="underline hover:text-sky-500">Google AI Studio</a>.</p>
            </div>
        </div>
    );
};

const ConfirmModal = ({ isOpen, onConfirm, onCancel, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
      <div className="bg-slate-200/50 dark:bg-slate-900/40 backdrop-blur-2xl rounded-2xl shadow-xl max-w-sm w-full p-6 border border-slate-300 dark:border-white/20 animate-in fade-in-0 zoom-in-95">
        <h2 className="text-xl font-bold text-slate-900 dark:text-white mb-3">{title}</h2>
        <div className="text-slate-600 dark:text-slate-300 mb-6 space-y-3">{children}</div>
        <div className="flex justify-end gap-4">
          <button onClick={onCancel} className="px-4 py-2 rounded-lg text-slate-800 dark:text-white bg-slate-300/50 hover:bg-slate-400/50 dark:bg-white/10 dark:hover:bg-white/20 transition-colors">Cancel</button>
          <button onClick={onConfirm} className="px-4 py-2 rounded-lg text-white bg-red-600 hover:bg-red-500 transition-colors">Reset Conversation</button>
        </div>
      </div>
    </div>
  );
};

const ErrorToast = ({ message, onDismiss }) => {
  useEffect(() => {
    if (message) {
      const timer = setTimeout(() => onDismiss(), 5000);
      return () => clearTimeout(timer);
    }
  }, [message, onDismiss]);

  if (!message) return null;
  return (
    <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-full max-w-md p-4 bg-red-200/80 dark:bg-red-500/20 backdrop-blur-xl border border-red-400 dark:border-red-500/50 text-red-800 dark:text-red-200 rounded-xl shadow-2xl animate-in fade-in-0 slide-in-from-top-4">
      <div className="flex items-start">
        <div className="flex-shrink-0"><svg className="h-6 w-6 text-red-600 dark:text-red-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div>
        <div className="ml-3 flex-1"><p className="text-sm font-medium">{message}</p></div>
        <div className="ml-4 flex-shrink-0 flex"><button onClick={onDismiss} className="inline-flex rounded-md text-red-800/70 dark:text-red-200/70 hover:text-red-800 dark:hover:text-red-200 focus:outline-none"><span className="sr-only">Dismiss</span><svg className="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" /></svg></button></div>
      </div>
    </div>
  );
};

const LanguageSelector = ({ selectedLanguage, onLanguageChange, id, disabled, onVisibilityChange, isRotated }) => {
  const [isOpen, setIsOpen] = useState(false);
  const selectorRef = useRef(null);

  const setMenuOpen = (open) => {
    setIsOpen(open);
    onVisibilityChange(open);
  };

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (selectorRef.current && !selectorRef.current.contains(event.target)) setMenuOpen(false);
    };
    if (isOpen) document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [isOpen, onVisibilityChange]);

  const handleSelect = (langName) => {
    onLanguageChange(langName);
    setMenuOpen(false);
  };
  const handleToggle = () => !disabled && setMenuOpen(!isOpen);
  const menuPositionClass = isRotated ? 'bottom-full mb-1' : 'top-full mt-1';

  return (
    <div ref={selectorRef} className="relative w-64">
      <button id={id} disabled={disabled} onClick={handleToggle} className="w-full bg-slate-200/50 dark:bg-black/20 backdrop-blur-md border border-slate-300 dark:border-white/20 text-slate-900 dark:text-white rounded-lg focus:ring-2 focus:ring-sky-500 dark:focus:ring-sky-400 focus:border-sky-500 dark:focus:border-sky-400 transition duration-150 py-2.5 px-3 disabled:opacity-50 flex justify-between items-center" aria-haspopup="listbox" aria-expanded={isOpen}>
        <span className="truncate">{selectedLanguage}</span>
        <svg className={`w-5 h-5 transition-transform duration-200 ${isOpen ? 'transform rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
      </button>
      {isOpen && (
        <div className={`absolute left-0 right-0 z-10 bg-slate-100/80 dark:bg-slate-800/80 backdrop-blur-lg border border-slate-300 dark:border-white/20 rounded-lg shadow-lg overflow-hidden animate-in fade-in-0 zoom-in-95 ${menuPositionClass}`}>
          <ul className="max-h-60 overflow-y-auto" role="listbox">
            {SUPPORTED_LANGUAGES.map(lang => {
               if (lang.isHeader) {
                   return <li key={lang.name} className="px-3 pt-3 pb-1 font-bold text-sky-600 dark:text-sky-400 text-sm select-none sticky top-0 bg-slate-100/80 dark:bg-slate-800/80">{lang.name}</li>;
               }
               return (
                   <li key={lang.code} className="pl-4 pr-3 py-2 text-slate-900 dark:text-white hover:bg-sky-100 dark:hover:bg-sky-500/20 cursor-pointer" onClick={() => handleSelect(lang.name)} role="option" aria-selected={selectedLanguage === lang.name}>
                       {lang.name}
                   </li>
               );
            })}
          </ul>
        </div>
      )}
    </div>
  );
};

const MessageBubble = ({ original, translated, isMine }) => {
  const bubbleClasses = isMine ? 'bg-sky-500 text-white dark:bg-sky-600/50 rounded-br-none' : 'bg-slate-200 text-slate-900 dark:bg-slate-700/50 dark:text-white rounded-bl-none';
  const originalTextClasses = isMine ? 'text-sky-100 dark:text-slate-300' : 'text-slate-600 dark:text-slate-300';
  return (
    <div className={`rounded-2xl px-4 py-2 backdrop-blur-lg border border-black/10 dark:border-white/10 shadow-lg ${bubbleClasses}`}>
        <p className="font-semibold">{translated}</p>
        <p className={`text-sm opacity-80 mt-1 ${originalTextClasses}`}>{original}</p>
    </div>
  );
};

const ConversationLog = ({ conversation, mySide, isRotated }) => {
  const conversationEndRef = useRef(null);
  useEffect(() => {
    conversationEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [conversation]);

  return (
    <div className="flex-grow w-full p-4 overflow-y-auto flex flex-col-reverse">
      <div className="flex flex-col gap-4">
        <div ref={conversationEndRef} />
        {conversation.map(msg => {
          const isMine = msg.side === mySide;
          const isAlignedRight = isRotated ? !isMine : isMine;
          return (
            <div key={msg.id} className={`flex flex-col max-w-xs md:max-w-md ${isAlignedRight ? 'self-end items-end' : 'self-start items-start'}`}>
                <MessageBubble original={msg.original} translated={msg.translated} isMine={isMine} />
            </div>
          )
        }).reverse()}
      </div>
    </div>
  );
};

const ActionToolbar = ({ onDownload, onReset, onToggleTheme, theme, isSummarizing, isBusy, hasConversation, onForgetApiKey, isB1Mode, onB1ModeChange, onSwapPatientSide, patientSide }) => {
    const [showSettings, setShowSettings] = useState(false);
    
    const ThemeToggleButton = ({ theme, onToggle }) => (
        <button onClick={onToggle} className="relative w-12 h-12 flex items-center justify-center rounded-full text-slate-600 dark:text-slate-300 hover:text-black dark:hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500 transition-colors duration-300" aria-label="Toggle theme">
        <SunIcon className={`w-7 h-7 absolute transition-all duration-300 ease-in-out ${theme === 'light' ? 'opacity-100 rotate-0 scale-100' : 'opacity-0 -rotate-90 scale-50'}`} />
        <MoonIcon className={`w-6 h-6 absolute transition-all duration-300 ease-in-out ${theme === 'dark' ? 'opacity-100 rotate-0 scale-100' : 'opacity-0 rotate-90 scale-50'}`} />
        </button>
    );

    return (
        <div className="flex-shrink-0 h-24 sm:h-20 bg-slate-100/80 dark:bg-black/30 backdrop-blur-lg border-y border-slate-300/80 dark:border-white/10 flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-6 py-2 px-4">
            <div className="flex items-center gap-2 sm:gap-6">
                <button onClick={onDownload} disabled={isBusy || isSummarizing || !hasConversation} className="p-2 text-slate-600 dark:text-slate-300 hover:text-black dark:hover:text-white disabled:text-slate-400 dark:disabled:text-slate-600 disabled:cursor-not-allowed transition-colors" aria-label="Download conversation">
                    {isSummarizing ? <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-current"></div> : <DownloadIcon className="w-7 h-7" />}
                </button>
                <ThemeToggleButton theme={theme} onToggle={onToggleTheme} />
                <button onClick={() => setShowSettings(true)} disabled={isBusy || isSummarizing} className="p-2 text-slate-600 dark:text-slate-300 hover:text-black dark:hover:text-white disabled:text-slate-400 dark:disabled:text-slate-600 disabled:cursor-not-allowed transition-colors" aria-label="Settings">
                    <SettingsIcon className="w-7 h-7" />
                </button>
            </div>
            <div className="h-px sm:h-8 w-1/2 sm:w-px bg-slate-300 dark:bg-slate-700"></div>
            <div className="flex items-center gap-2 sm:gap-4">
                 <div className="flex items-center gap-2">
                    <label htmlFor="b1-toggle" className="text-sm font-medium text-slate-700 dark:text-slate-300 cursor-pointer">Simplify for Patient (B1)</label>
                    <button id="b1-toggle" onClick={onB1ModeChange} className={`relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 ${isB1Mode ? 'bg-sky-600' : 'bg-gray-300 dark:bg-gray-600'}`}>
                        <span className={`inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${isB1Mode ? 'translate-x-5' : 'translate-x-0'}`}></span>
                    </button>
                </div>
                <button onClick={onSwapPatientSide} className="p-2 text-slate-600 dark:text-slate-300 hover:text-black dark:hover:text-white disabled:text-slate-400 dark:disabled:text-slate-600 disabled:cursor-not-allowed transition-colors" aria-label="Swap patient side">
                    <SwapIcon className="w-7 h-7" />
                </button>
            </div>

            <ConfirmModal 
              isOpen={showSettings} 
              onConfirm={() => { onReset(); setShowSettings(false); }} 
              onCancel={() => setShowSettings(false)} 
              title="Settings & Reset">
                <p>This will permanently delete the current conversation history.</p>
                <div className="mt-4 p-3 bg-yellow-100/50 dark:bg-yellow-500/10 border-l-4 border-yellow-400 dark:border-yellow-500 text-yellow-800 dark:text-yellow-200 text-sm">
                    <strong>Disclaimer:</strong> This tool is an aid and not a substitute for a professional medical interpreter. Please verify critical information.
                </div>
                <button 
                  onClick={(e) => { e.stopPropagation(); onForgetApiKey(); setShowSettings(false); }} 
                  className="w-full mt-4 px-4 py-2 rounded-lg text-slate-800 dark:text-white bg-slate-300/50 hover:bg-slate-400/50 dark:bg-white/10 dark:hover:bg-white/20 transition-colors text-sm">
                    Forget API Key
                </button>
            </ConfirmModal>
        </div>
    );
};

const UserView = ({ side, lang, onLangChange, conversation, activeSide, isProcessing, onMicClick, isRotated, onMenuVisibilityChange, isPatientSide }) => {
  const isThisSideListening = activeSide === side;
  const isThisSideProcessing = isProcessing && activeSide === side;
  const isAnySideBusy = !!activeSide;
  const isDisabled = isAnySideBusy && !isThisSideListening;

  const getStatusText = () => {
    const mainLang = lang.split('(')[0].trim();
    const t = STATUS_TRANSLATIONS[mainLang] || STATUS_TRANSLATIONS['English'];
    if (isThisSideProcessing) return t.translating;
    if (isThisSideListening) return t.listening;
    if (isAnySideBusy) return t.waiting;
    return t.tapToSpeak;
  };
  const statusText = getStatusText();
  
  return (
    <div className={`w-full h-full bg-white/40 dark:bg-black/20 backdrop-blur-2xl flex flex-col items-center p-2 sm:p-4 gap-2 ${isRotated ? 'transform rotate-180' : ''}`}>
      <div className="w-full max-w-md flex items-center justify-center relative">
        <LanguageSelector id={`${side}-lang-selector`} selectedLanguage={lang} onLanguageChange={onLangChange} disabled={isAnySideBusy} onVisibilityChange={onMenuVisibilityChange} isRotated={isRotated} />
        {isPatientSide && <span className="absolute -top-2 -right-1 bg-sky-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">PATIENT</span>}
      </div>
      <ConversationLog conversation={conversation} mySide={side} isRotated={isRotated} />
      <div className="flex flex-col items-center gap-1 sm:gap-2">
        <button onClick={() => onMicClick(side)} disabled={isDisabled} className={`relative flex items-center justify-center w-20 h-20 rounded-full transition-all duration-300 ease-in-out shadow-lg ${isThisSideListening ? 'bg-red-600 scale-105' : 'bg-gradient-to-br from-sky-400 to-sky-600 hover:from-sky-500 hover:to-sky-700 shadow-sky-500/40'} ${isDisabled && !isThisSideListening ? 'bg-slate-400/80 dark:bg-slate-600 cursor-not-allowed opacity-50' : ''}`} aria-label={isThisSideListening ? 'Stop listening' : 'Start listening'}>
          {isThisSideProcessing ? <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-white"></div> : <MicIcon className="w-10 h-10 text-white" />}
          {isThisSideListening && <div className="absolute inset-0 rounded-full listening-pulse" style={{ animationDelay: '-0.5s' }}></div>}
        </button>
        <p className="text-slate-600 dark:text-slate-400 text-xs sm:text-sm h-5 text-center px-2">{statusText}</p>
      </div>
    </div>
  );
};

// --- MAIN APP COMPONENT ---
function App() {
  const [theme, toggleTheme] = useTheme();
  const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini-api-key'));
  const [userALang, setUserALang] = useState('English (US)');
  const [userBLang, setUserBLang] = useState('Spanish (Mexico)');
  const [conversation, setConversation] = useState([]);
  const [activeSide, setActiveSide] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [isSummarizing, setIsSummarizing] = useState(false);
  const [error, setError] = useState(null);
  const [activeMenu, setActiveMenu] = useState(null);
  const [isB1Mode, setIsB1Mode] = useState(true);
  const [patientSide, setPatientSide] = useState('userB');

  const aiRef = useRef(null);
  const recognitionRef = useRef(null);
  const transcriptRef = useRef('');
  const finalTranscriptRef = useRef('');

  useEffect(() => {
    if (apiKey) {
      try {
        aiRef.current = new GoogleGenAI({ apiKey });
        localStorage.setItem('gemini-api-key', apiKey);
      } catch (e) {
        setError("Failed to initialize with the provided API key. It might be invalid.");
        setApiKey(null);
        localStorage.removeItem('gemini-api-key');
      }
    } else {
        aiRef.current = null;
    }
  }, [apiKey]);
  
  const handleSetApiKey = (key) => setApiKey(key);
  const handleForgetApiKey = () => {
    setApiKey(null);
    localStorage.removeItem('gemini-api-key');
  };
  const handleSwapPatientSide = () => setPatientSide(prev => prev === 'userA' ? 'userB' : 'userA');

  const translateText = useCallback(async (text, sourceLang, targetLang, simplify = false) => {
    if (!text.trim() || !aiRef.current) return "";
    
    const standardPrompt = `You are an expert linguist and translator. Your task is to provide a highly accurate and natural-sounding translation.
- Translate the following text from **${sourceLang}** to **${targetLang}**.
- Pay close attention to nuances, idiomatic expressions, and cultural context.
- If a dialect is specified, adhere to its specific vocabulary and grammatical structures.
- The final output must be **only the translated text**, with no additional explanations, introductions, or quotation marks. The accuracy must be at least 95%.`;

    const simplifiedPrompt = `You are an expert linguist and translator, specializing in medical communication for diverse audiences. Your task is to provide a compassionate, clear, and accurate translation.
- Translate the following text from **${sourceLang}** to **${targetLang}**.
- **Crucially, the target audience is a low-literate patient in a stressful hospital environment. Simplify the translated language to a B1 (Intermediate) level.**
  - Use short, simple sentences.
  - Use common, everyday vocabulary.
  - Avoid medical jargon, complex terms, and idiomatic expressions that might be confusing.
  - Maintain a respectful and clear tone.
- If a dialect is specified for the target language, adhere to its specific vocabulary and grammatical structures while maintaining the B1 simplicity.
- The final output must be **only the simplified, translated text**, with no additional explanations or introductions.`;

    const prompt = `${simplify ? simplifiedPrompt : standardPrompt}\n\nText to translate:\n"${text}"`;

    try {
      const response = await aiRef.current.models.generateContent({
        model: "gemini-2.5-flash",
        contents: prompt,
        config: { thinkingConfig: { thinkingBudget: 0 } },
      });
      return response.text.trim();
    } catch (error) {
      console.error("Error translating text:", error);
      if (error instanceof Error && (error.message.includes('API key not valid') || error.message.includes('API key is missing'))) {
        throw new Error("The API key is invalid or has been rejected. Please verify it.");
      }
      throw new Error("Translation failed. The model may be unavailable or there is a network issue.");
    }
  }, []);

  const summarizeConversation = useCallback(async (conversation, langA, langB) => {
    if (conversation.length === 0 || !aiRef.current) return "The conversation was empty.";
    const conversationText = conversation.map(msg => {
        const speaker = msg.side === 'userA' ? `Staff (${langA})` : `Patient (${langB})`;
        return `${speaker}: "${msg.original}"`;
      }).join('\n');
    const prompt = `Please provide a brief, neutral summary in English of the following conversation between hospital staff (${langA}) and a patient (${langB}).\n\nConversation History:\n---\n${conversationText}\n---\n\nSummary:`;
    try {
      const response = await aiRef.current.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
      return response.text.trim();
    } catch (error) {
      console.error("Error summarizing conversation:", error);
      throw new Error("Could not generate summary.");
    }
  }, []);
  
  const speak = useCallback((text, langName) => {
    return new Promise((resolve, reject) => {
      try {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        const bcp47Lang = LANG_NAME_TO_BCP47[langName];
        if (bcp47Lang) utterance.lang = bcp47Lang;
        utterance.onend = () => resolve();
        utterance.onerror = (e) => reject(e);
        window.speechSynthesis.speak(utterance);
      } catch (e) {
        console.error("Speech synthesis failed.", e);
        setError("Sorry, the translation could not be spoken.");
        reject(e);
      }
    });
  }, []);
  
  const processTranslation = useCallback(async (text, speakerSide) => {
    if (!text.trim()) {
        setIsProcessing(false);
        setActiveSide(null);
        return;
    }
    setIsProcessing(true);
    setError(null);
    const sourceLang = speakerSide === 'userA' ? userALang : userBLang;
    const targetLang = speakerSide === 'userA' ? userBLang : userALang;
    const targetSide = speakerSide === 'userA' ? 'userB' : 'userA';
    const shouldSimplify = isB1Mode && targetSide === patientSide;

    try {
      const translated = await translateText(text, sourceLang, targetLang, shouldSimplify);
      setConversation(prev => [...prev, { id: Date.now(), original: text, translated, side: speakerSide }]);
      await speak(translated, targetLang);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An unknown error occurred.');
       if (err.message.includes("API key is invalid")) handleForgetApiKey();
    } finally {
        setIsProcessing(false);
    }
  }, [userALang, userBLang, speak, translateText, isB1Mode, patientSide]);

  const stopRecognition = useCallback(() => {
    if (recognitionRef.current) {
        recognitionRef.current.stop();
        recognitionRef.current = null;
    }
    setActiveSide(null);
  }, []);
  
  const startRecognition = useCallback((side) => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
          setError("Speech recognition is not supported in this browser.");
          return;
      }
      stopRecognition();
      const recognition = new SpeechRecognition();
      recognitionRef.current = recognition;
      transcriptRef.current = '';
      finalTranscriptRef.current = '';

      const currentLang = side === 'userA' ? userALang : userBLang;
      recognition.lang = LANG_NAME_TO_BCP47[currentLang] || 'en-US';
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onresult = (event) => {
          let interim_transcript = '';
          for (let i = event.resultIndex; i < event.results.length; ++i) {
              if (event.results[i].isFinal) {
                  finalTranscriptRef.current += event.results[i][0].transcript;
              } else {
                  interim_transcript += event.results[i][0].transcript;
              }
          }
          transcriptRef.current = finalTranscriptRef.current + interim_transcript;
      };

      recognition.onend = () => { setActiveSide(null); recognitionRef.current = null; };
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'not-allowed') setError("Microphone permission was denied. Please allow microphone access in your browser settings.");
        else if (event.error !== 'aborted' && event.error !== 'no-speech') setError(`Speech recognition error: ${event.error}`);
        setActiveSide(null);
      };
      recognition.start();
      setActiveSide(side);
  }, [userALang, userBLang, stopRecognition]);

  const handleMicClick = useCallback(async (side) => {
    if (activeSide === side) {
        const finalTranscript = transcriptRef.current.trim();
        stopRecognition();
        transcriptRef.current = ''; finalTranscriptRef.current = '';
        if (finalTranscript) processTranslation(finalTranscript, side);
        return;
    }
    if (activeSide) return;
    startRecognition(side);
  }, [activeSide, startRecognition, stopRecognition, processTranslation]);

  const executeReset = () => {
    setConversation([]);
    setError(null);
    stopRecognition();
    setIsProcessing(false);
    window.speechSynthesis.cancel();
  };

  const handleDownload = async () => {
    if (conversation.length === 0) return;
    setIsSummarizing(true);
    setError(null);
    try {
        const staffLang = patientSide === 'userA' ? userBLang : userALang;
        const patientLang = patientSide === 'userA' ? userALang : userBLang;
        const summary = await summarizeConversation(conversation, staffLang, patientLang);
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        let y = margin;
        
        doc.setFont("helvetica", "bold"); doc.setFontSize(18); doc.text("Clinical Conversation Report", pageWidth / 2, y, { align: 'center' }); y += 7;
        doc.setFont("helvetica", "normal"); doc.setFontSize(10); doc.setTextColor(100); doc.text(new Date().toLocaleString(), pageWidth / 2, y, { align: 'center' }); y += 15;
        doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.setTextColor(0); doc.text("Summary", margin, y); y += 6;
        doc.setFont("helvetica", "normal"); doc.setFontSize(11); const summaryLines = doc.splitTextToSize(summary, pageWidth - margin * 2); doc.text(summaryLines, margin, y); y += summaryLines.length * 5 + 10;
        doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.text("Full Transcript", margin, y); y += 8;

        conversation.forEach(msg => {
            if (y > doc.internal.pageSize.getHeight() - 30) { doc.addPage(); y = margin; }
            const isPatient = msg.side === patientSide;
            const speaker = isPatient ? `Patient (${isPatient ? patientLang : staffLang})` : `Staff (${isPatient ? patientLang : staffLang})`;
            doc.setFont("helvetica", "bold"); doc.setFontSize(11); doc.text(speaker, margin, y); y += 5;
            doc.setFont("helvetica", "italic"); doc.setFontSize(10); doc.setTextColor(100); const originalLines = doc.splitTextToSize(`Original: ${msg.original}`, pageWidth - margin * 2 - 5); doc.text(originalLines, margin + 2, y); y += originalLines.length * 4 + 2;
            doc.setFont("helvetica", "normal"); doc.setTextColor(0); const translatedLines = doc.splitTextToSize(`Translated: ${msg.translated}`, pageWidth - margin * 2 - 5); doc.text(translatedLines, margin + 2, y); y += translatedLines.length * 4 + 6;
        });

        doc.save(`conversation-report-${new Date().toISOString().split('T')[0]}.pdf`);
    } catch (err) {
        setError(err instanceof Error ? err.message : 'An unknown error occurred.');
    } finally {
        setIsSummarizing(false);
    }
  };

  const handleMenuVisibility = (side, isVisible) => setActiveMenu(isVisible ? side : (activeMenu === side ? null : activeMenu));
  const isBusy = !!activeSide || isProcessing;
  if (!apiKey) return <ApiKeyGate onKeySubmit={handleSetApiKey} />;

  return (
    <div className="h-screen bg-transparent text-slate-900 dark:text-slate-200 flex flex-col font-sans overflow-hidden">
        <ErrorToast message={error} onDismiss={() => setError(null)} />
    
        <div className={`h-1/2 relative ${activeMenu === 'userA' ? 'z-20' : ''}`}>
            <UserView side="userA" lang={userALang} onLangChange={setUserALang} conversation={conversation} activeSide={activeSide} isProcessing={isProcessing} onMicClick={handleMicClick} isRotated={true} onMenuVisibilityChange={(isVisible) => handleMenuVisibility('userA', isVisible)} isPatientSide={patientSide === 'userA'} />
        </div>
        
        <div className="relative z-10">
            <ActionToolbar onDownload={handleDownload} onReset={executeReset} onToggleTheme={toggleTheme} theme={theme} isSummarizing={isSummarizing} isBusy={isBusy} hasConversation={conversation.length > 0} onForgetApiKey={handleForgetApiKey} isB1Mode={isB1Mode} onB1ModeChange={() => setIsB1Mode(p => !p)} onSwapPatientSide={handleSwapPatientSide} patientSide={patientSide} />
        </div>

        <div className={`h-1/2 relative ${activeMenu === 'userB' ? 'z-20' : ''}`}>
            <UserView side="userB" lang={userBLang} onLangChange={setUserBLang} conversation={conversation} activeSide={activeSide} isProcessing={isProcessing} onMicClick={handleMicClick} isRotated={false} onMenuVisibilityChange={(isVisible) => handleMenuVisibility('userB', isVisible)} isPatientSide={patientSide === 'userB'} />
        </div>

        <div className="fixed bottom-4 right-4 z-30 opacity-50 hover:opacity-100 transition-opacity duration-300">
            <AppLogo className="w-10 h-10" />
        </div>
    </div>
  );
}

// --- RENDERER ---
const rootElement = document.getElementById('root');
if (!rootElement) throw new Error("Could not find root element to mount to");
const root = ReactDOM.createRoot(rootElement);
root.render(<React.StrictMode><App /></React.StrictMode>);
</script>
</body>
</html>